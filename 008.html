<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω Chi Ti√™u N√¢ng Cao</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        /* ==================== CSS C∆† B·∫¢N & T·ªêI ∆ØU UI/UX ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .nav-tabs {
            display: flex;
            background: #e9ecef;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-btn {
            flex-grow: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 600;
            color: #495057;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: #f8f9fa;
        }

        .tab-btn.active {
            color: #007bff;
            background: white;
            border-bottom: 3px solid #007bff;
        }

        .tab-content {
            padding: 20px 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        /* ==================== FORM & INPUT ==================== */
        .form-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr) 150px;
            gap: 20px;
            margin-bottom: 20px;
            align-items: end;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input[type="number"],
        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3); /* Hi·ªáu ·ª©ng focus */
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        /* ==================== DANH S√ÅCH GIAO D·ªäCH ==================== */
        .transaction-list {
            margin-top: 20px;
        }

        .list-header, .transaction-item {
            display: grid;
            grid-template-columns: 1fr 1fr 2fr 1.5fr 150px;
            padding: 10px 10px;
            align-items: center;
        }

        .list-header {
            font-weight: 700;
            background-color: #f8f9fa;
            border-bottom: 2px solid #eee;
            border-top: 1px solid #eee;
        }

        .transaction-item {
            border-bottom: 1px solid #eee;
        }

        .transaction-item:hover {
            background-color: #f8f9fa;
        }

        .amount {
            font-weight: 600;
            color: #dc3545;
        }

        .actions-cell {
            display: flex;
            gap: 5px;
        }
        
        .edit-btn {
            background-color: #ffc107;
            color: #333;
        }

        /* ==================== B√ÅO C√ÅO & TH·ªêNG K√ä (UI/UX T·ªêI ∆ØU) ==================== */
        .stats-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); /* ƒê·ªï b√≥ng m·∫°nh h∆°n */
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover { /* Hi·ªáu ·ª©ng hover */
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .stat-card.total { background: #e6f7ff; border-left: 5px solid #007bff; }
        .stat-card.avg { background: #fff3e0; border-left: 5px solid #ff9800; }
        .stat-card.max { background: #ffe0e6; border-left: 5px solid #e91e63; }

        .stat-card h3 {
            font-size: 14px;
            color: #555;
            margin-bottom: 8px;
        }

        .stat-card p {
            font-size: 26px; /* Font l·ªõn h∆°n */
            font-weight: 700;
            color: #333;
        }

        .chart-card {
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            background: white;
            transition: box-shadow 0.3s;
        }

        .chart-card:hover {
             box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }


        /* ==================== MODAL CH·ªàNH S·ª¨A (UI/UX T·ªêI ∆ØU) ==================== */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.6); /* N·ªÅn t·ªëi h∆°n */
            padding-top: 50px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: none;
            width: 90%;
            max-width: 550px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            position: relative;
        }
        
        .modal-content h2 {
            color: #007bff;
            border-bottom: 2px solid #007bff;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 36px;
            font-weight: bold;
            line-height: 1;
        }
        
        /* ==================== RESPONSIVE (GI·ªÆ NGUY√äN) ==================== */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { border-radius: 10px; }
            .header { padding: 15px; }
            .tab-btn { font-size: 14px; padding: 12px 5px; }
            .tab-content { padding: 15px; }
            .form-row, .search-filters {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .list-header, .transaction-item {
                grid-template-columns: 1fr 1fr 1fr 1fr 90px;
            }
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .stats-summary {
                grid-template-columns: 1fr;
            }
            .limit-settings {
                grid-template-columns: 1fr;
            }
            .modal-content {
                 margin: 10% auto;
                 padding: 20px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>H·ªá Th·ªëng Qu·∫£n L√Ω Chi Ti√™u N√¢ng Cao</h1>
    </div>

    <div class="nav-tabs">
        <button class="tab-btn active" data-tab="tab-transaction">üí∏ Giao D·ªãch</button>
        <button class="tab-btn" data-tab="tab-search">üîç T√¨m Ki·∫øm</button>
        <button class="tab-btn" data-tab="tab-report">üìä B√°o C√°o</button>
        <button class="tab-btn" data-tab="tab-limit">üõë Gi·ªõi H·∫°n</button>
        <button class="tab-btn" data-tab="tab-tools">üîß C√¥ng C·ª•</button>
    </div>

    <div id="tab-transaction" class="tab-content active">
        <h2>Th√™m Giao D·ªãch M·ªõi</h2>
        <form id="add-transaction-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="amount">S·ªë Ti·ªÅn (VND)</label>
                    <input type="number" id="amount" min="1000" required>
                </div>
                <div class="form-group">
                    <label for="category">Danh M·ª•c</label>
                    <select id="category" required>
                        <option value="">-- Ch·ªçn Danh M·ª•c --</option>
                        <option value="ƒÇn u·ªëng">ƒÇn u·ªëng</option>
                        <option value="Di chuy·ªÉn">Di chuy·ªÉn</option>
                        <option value="Nh√† ·ªü">Nh√† ·ªü</option>
                        <option value="H·ªçc t·∫≠p">H·ªçc t·∫≠p</option>
                        <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
                        <option value="S·ª©c kh·ªèe">S·ª©c kh·ªèe</option>
                        <option value="Kh√°c">Kh√°c</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="date">Ng√†y</label>
                    <input type="date" id="date" value="" required>
                </div>
                <div class="form-group" style="grid-column: span 1 / span 1;">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">‚ûï Th√™m</button>
                </div>
            </div>
            <div class="form-group">
                <label for="note">Ghi Ch√∫</label>
                <input type="text" id="note" maxlength="100">
            </div>
        </form>

        <h2>L·ªãch S·ª≠ Giao D·ªãch</h2>
        <div class="quick-filter-group" style="margin-bottom: 15px;">
            <button class="btn btn-primary" onclick="updateTransactionList('week', 'transaction-items', true)">Tu·∫ßn N√†y</button>
            <button class="btn btn-primary" onclick="updateTransactionList('month', 'transaction-items', true)">Th√°ng N√†y</button>
            <button class="btn btn-primary" onclick="updateTransactionList('all', 'transaction-items', true)">T·∫•t C·∫£</button>
        </div>
        
        <div class="transaction-list">
            <div class="list-header">
                <span class="sort-header asc" data-sort-by="date">Ng√†y</span>
                <span class="sort-header" data-sort-by="amount">S·ªë Ti·ªÅn</span>
                <span>Danh M·ª•c</span>
                <span>Ghi Ch√∫</span>
                <span>Thao T√°c</span>
            </div>
            <div id="transaction-items">
                <p style="text-align: center; padding: 20px;">Ch∆∞a c√≥ giao d·ªãch n√†o ƒë∆∞·ª£c ghi l·∫°i.</p>
            </div>
        </div>
    </div>

    <div id="tab-search" class="tab-content">
        <h2>T√¨m Ki·∫øm Giao D·ªãch N√¢ng Cao</h2>
        <div class="search-filters">
            <div class="form-group">
                <label for="search-from-date">T·ª´ Ng√†y</label>
                <input type="date" id="search-from-date">
            </div>
            <div class="form-group">
                <label for="search-to-date">ƒê·∫øn Ng√†y</label>
                <input type="date" id="search-to-date">
            </div>
            <div class="form-group">
                <label for="search-category">Danh M·ª•c</label>
                <select id="search-category">
                    <option value="">-- T·∫•t C·∫£ --</option>
                    <option value="ƒÇn u·ªëng">ƒÇn u·ªëng</option>
                    <option value="Di chuy·ªÉn">Di chuy·ªÉn</option>
                    <option value="Nh√† ·ªü">Nh√† ·ªü</option>
                    <option value="H·ªçc t·∫≠p">H·ªçc t·∫≠p</option>
                    <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
                    <option value="S·ª©c kh·ªèe">S·ª©c kh·ªèe</option>
                    <option value="Kh√°c">Kh√°c</option>
                </select>
            </div>
            <div class="form-group">
                <label for="search-min-amount">S·ªë Ti·ªÅn T·ªëi Thi·ªÉu</label>
                <input type="number" id="search-min-amount" min="0">
            </div>
            <div class="form-group">
                <label for="search-note">Ghi Ch√∫ (ch·ª©a)</label>
                <input type="text" id="search-note">
            </div>
            <div class="form-group">
                <button id="perform-search-btn" class="btn btn-primary" style="width: 100%;">üîç T√¨m Ki·∫øm</button>
            </div>
        </div>

        <h2>K·∫øt Qu·∫£ T√¨m Ki·∫øm</h2>
        <div class="transaction-list">
            <div class="list-header">
                <span class="sort-header asc" data-sort-by="date">Ng√†y</span>
                <span class="sort-header" data-sort-by="amount">S·ªë Ti·ªÅn</span>
                <span>Danh M·ª•c</span>
                <span>Ghi Ch√∫</span>
                <span>Thao T√°c</span>
            </div>
            <div id="search-results-items">
                <p style="text-align: center; padding: 20px;">H√£y s·ª≠ d·ª•ng c√°c b·ªô l·ªçc ƒë·ªÉ t√¨m ki·∫øm.</p>
            </div>
        </div>
        <p style="margin-top: 15px; font-weight: bold;">T·ªïng chi ti√™u t√¨m ki·∫øm: <span id="search-total-amount">0 VND</span></p>
    </div>

    <div id="tab-report" class="tab-content">
        <h2>B√°o C√°o & Th·ªëng K√™</h2>
        
        <h3>T·ªïng Quan Theo Th·ªùi Gian</h3>
        <div class="report-controls">
            <button class="btn btn-primary" data-period="month" onclick="updateStats('month')">Th√°ng N√†y</button>
            <button class="btn btn-primary" data-period="year" onclick="updateStats('year')">NƒÉm N√†y</button>
            <button class="btn btn-primary" data-period="all" onclick="updateStats('all')">T·∫•t C·∫£</button>
        </div>
        <div class="stats-summary">
            <div class="stat-card total">
                <h3>T·ªïng Chi Ti√™u (<span id="stats-period-name">Th√°ng N√†y</span>)</h3>
                <p id="stats-total-expense">0 VND</p>
            </div>
            <div class="stat-card avg">
                <h3>Chi Ti√™u Trung B√¨nh/Ng√†y</h3>
                <p id="stats-avg-daily-expense">0 VND</p>
            </div>
            <div class="stat-card max">
                <h3>Chi Ti√™u L·ªõn Nh·∫•t</h3>
                <p id="stats-max-expense">0 VND</p>
            </div>
        </div>

        <h3>Bi·ªÉu ƒê·ªì Ph√¢n T√≠ch</h3>
        <div class="chart-grid">
            <div class="chart-card">
                <h4>Ph√¢n T√≠ch Theo Danh M·ª•c (T·ª∑ l·ªá %)</h4>
                <canvas id="categoryChart"></canvas>
            </div>
            <div class="chart-card">
                <h4>Ph√¢n T√≠ch Theo Th√°ng (12 Th√°ng G·∫ßn Nh·∫•t)</h4>
                <canvas id="monthlyChart"></canvas>
            </div>
            <div class="chart-card" style="grid-column: span 2;">
                <h4>Bi·∫øn ƒê·ªông Chi Ti√™u Theo Ng√†y (30 Ng√†y G·∫ßn Nh·∫•t)</h4>
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>

    <div id="tab-limit" class="tab-content">
        <h2>Thi·∫øt L·∫≠p Gi·ªõi H·∫°n Chi Ti√™u</h2>
        <div class="limit-settings">
            <div class="form-group">
                <label for="limit-category">Ch·ªçn Danh M·ª•c</label>
                <select id="limit-category" required>
                    <option value="Daily">H√†ng Ng√†y (T·ªïng)</option>
                    <option value="Monthly">H√†ng Th√°ng (T·ªïng)</option>
                    <option value="ƒÇn u·ªëng">ƒÇn u·ªëng</option>
                    <option value="Di chuy·ªÉn">Di chuy·ªÉn</option>
                    <option value="Nh√† ·ªü">Nh√† ·ªü</option>
                    <option value="H·ªçc t·∫≠p">H·ªçc t·∫≠p</option>
                    <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
                    <option value="S·ª©c kh·ªèe">S·ª©c kh·ªèe</option>
                    <option value="Kh√°c">Kh√°c</option>
                </select>
            </div>
            <div class="form-group">
                <label for="limit-amount">S·ªë Ti·ªÅn Gi·ªõi H·∫°n (VND)</label>
                <input type="number" id="limit-amount" min="1000" required>
            </div>
            <div class="form-group">
                <button id="set-limit-btn" class="btn btn-success" style="width: 100%;">Thi·∫øt L·∫≠p</button>
            </div>
        </div>

        <h2>T√¨nh Tr·∫°ng Gi·ªõi H·∫°n</h2>
        <div class="limit-list" id="limit-items">
            <p style="text-align: center; padding: 20px;">Ch∆∞a c√≥ gi·ªõi h·∫°n n√†o ƒë∆∞·ª£c thi·∫øt l·∫≠p.</p>
        </div>
    </div>
    
    <div id="tab-tools" class="tab-content">
        <h2>C√¥ng C·ª• D·ªØ Li·ªáu</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="border: 1px solid #ddd; padding: 20px; border-radius: 10px;">
                <h3>üì• Nh·∫≠p D·ªØ Li·ªáu (CSV)</h3>
                <p style="margin-bottom: 15px; font-size: 14px;">Ch·ªçn file CSV. ƒê·ªãnh d·∫°ng: ID, Ng√†y, S·ªë Ti·ªÅn, Danh M·ª•c, Ghi Ch√∫.</p>
                <input type="file" id="import-csv-file" accept=".csv" style="margin-bottom: 10px;">
                <button id="import-csv-btn" class="btn btn-success" disabled>Nh·∫≠p D·ªØ Li·ªáu</button>
            </div>
            <div style="border: 1px solid #ddd; padding: 20px; border-radius: 10px;">
                <h3>üì§ Xu·∫•t D·ªØ Li·ªáu (CSV)</h3>
                <p style="margin-bottom: 15px; font-size: 14px;">T·∫£i to√†n b·ªô d·ªØ li·ªáu giao d·ªãch v·ªÅ m√°y t√≠nh c·ªßa b·∫°n.</p>
                <button id="export-csv-btn" class="btn btn-primary">Xu·∫•t D·ªØ Li·ªáu</button>
            </div>
        </div>
        
        <h2 style="margin-top: 30px;">X√≥a D·ªØ Li·ªáu</h2>
        <button id="delete-all-btn" class="btn btn-danger" style="padding: 15px 20px;">‚ö†Ô∏è X√≥a To√†n B·ªô Giao D·ªãch</button>
        <p style="margin-top: 10px; font-size: 14px; color: #dc3545;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
    </div>
</div>

<div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Ch·ªânh S·ª≠a Giao D·ªãch</h2>
        <form id="edit-transaction-form">
            <input type="hidden" id="edit-id">
            <div class="form-group">
                <label for="edit-amount">S·ªë Ti·ªÅn (VND)</label>
                <input type="number" id="edit-amount" min="1000" required>
            </div>
            <div class="form-group">
                <label for="edit-category">Danh M·ª•c</label>
                <select id="edit-category" required>
                    <option value="ƒÇn u·ªëng">ƒÇn u·ªëng</option>
                    <option value="Di chuy·ªÉn">Di chuy·ªÉn</option>
                    <option value="Nh√† ·ªü">Nh√† ·ªü</option>
                    <option value="H·ªçc t·∫≠p">H·ªçc t·∫≠p</option>
                    <option value="Gi·∫£i tr√≠">Gi·∫£i tr√≠</option>
                    <option value="S·ª©c kh·ªèe">S·ª©c kh·ªèe</option>
                    <option value="Kh√°c">Kh√°c</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit-date">Ng√†y</label>
                <input type="date" id="edit-date" required>
            </div>
            <div class="form-group">
                <label for="edit-note">Ghi Ch√∫</label>
                <input type="text" id="edit-note" maxlength="100">
            </div>
            <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 20px;">L∆∞u Thay ƒê·ªïi</button>
        </form>
    </div>
</div>

<div id="notification"></div>

<script>
    // ==================== KH·ªûI T·∫†O V√Ä D·ªÆ LI·ªÜU ====================
    let transactions = []; 
    let limits = {};
    let categoryChart, monthlyChart, dailyChart;
    let currentSort = { column: 'date', direction: 'desc' }; 
    let currentPeriod = 'month'; 

    // L·∫•y ng√†y hi·ªán t·∫°i ·ªü ƒë·ªãnh d·∫°ng YYYY-MM-DD
    function getTodayDateString() {
        return new Date().toISOString().slice(0, 10);
    }

    // ƒê·∫∑t ng√†y m·∫∑c ƒë·ªãnh cho input date
    document.getElementById('date').value = getTodayDateString();
    
    // Load d·ªØ li·ªáu t·ª´ LocalStorage
    function loadData() {
        const storedTransactions = localStorage.getItem('transactions');
        const storedLimits = localStorage.getItem('limits');
        if (storedTransactions) {
            transactions = JSON.parse(storedTransactions).map(t => ({
                ...t,
                amount: Number(t.amount) 
            }));
        }
        if (storedLimits) {
            limits = JSON.parse(storedLimits);
        }
    }

    // L∆∞u d·ªØ li·ªáu v√†o LocalStorage
    function saveData() {
        localStorage.setItem('transactions', JSON.stringify(transactions));
        localStorage.setItem('limits', JSON.stringify(limits));
    }

    // ==================== C√ÅC H√ÄM TI·ªÜN √çCH ====================
    // ƒê·ªãnh d·∫°ng s·ªë ti·ªÅn
    function formatMoney(amount) {
        // ƒê·∫£m b·∫£o s·ªë ti·ªÅn l√† s·ªë nguy√™n
        amount = Math.round(amount); 
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    // ƒê·ªãnh d·∫°ng ng√†y (YYYY-MM-DD -> DD/MM/YYYY)
    function formatDate(dateString) {
        if (!dateString) return '';
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
    }

    // Hi·ªán th√¥ng b√°o (popup)
    function showNotification(message) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';
        clearTimeout(notification.timer);
        notification.timer = setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // ==================== CH·ª®C NƒÇNG CHUNG ====================
    // Chuy·ªÉn ƒë·ªïi tab
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const tabId = e.target.dataset.tab;

            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            e.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');

            // C·∫≠p nh·∫≠t l·∫°i bi·ªÉu ƒë·ªì v√† gi·ªõi h·∫°n khi chuy·ªÉn tab
            if (tabId === 'tab-report') {
                updateStats(currentPeriod);
            } else if (tabId === 'tab-limit') {
                updateLimitProgress();
            } else if (tabId === 'tab-transaction') {
                updateTransactionList('all', 'transaction-items', true); 
            }
        });
    });

    // ==================== TAB GIAO D·ªäCH ====================
    // Th√™m giao d·ªãch m·ªõi (Gi·ªØ nguy√™n)
    document.getElementById('add-transaction-form').addEventListener('submit', (e) => {
        e.preventDefault();

        const amount = Number(document.getElementById('amount').value);
        const category = document.getElementById('category').value;
        const date = document.getElementById('date').value;
        const note = document.getElementById('note').value.trim();

        if (amount <= 0 || !category || !date) {
            showNotification("‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return;
        }

        const newTransaction = {
            id: Date.now(), 
            date: date,
            amount: amount,
            category: category,
            note: note
        };

        transactions.push(newTransaction);
        saveData();
        updateTransactionList('all', 'transaction-items', true); // Hi·ªÉn th·ªã l·∫°i danh s√°ch
        updateLimitProgress(); 
        
        document.getElementById('add-transaction-form').reset();
        document.getElementById('date').value = getTodayDateString();
        showNotification("‚úÖ Th√™m giao d·ªãch th√†nh c√¥ng!");
    });

    // C·∫≠p nh·∫≠t danh s√°ch giao d·ªãch
    function updateTransactionList(filter = 'all', displayElementId = 'transaction-items', sortable = true) {
        let filteredList = [...transactions]; 

        // L·ªçc theo th·ªùi gian (Quick Filter)
        if (filter !== 'all') {
            const today = new Date();
            let startDate;

            if (filter === 'week') {
                // T√≠nh to√°n ng√†y ƒë·∫ßu tu·∫ßn (Th·ª© Hai)
                const day = today.getDay();
                const diff = today.getDate() - day + (day === 0 ? -6 : 1); 
                startDate = new Date(today.setDate(diff)).toISOString().slice(0, 10);
            } else if (filter === 'month') {
                // Ng√†y ƒë·∫ßu th√°ng
                startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().slice(0, 10);
            }
            
            if (startDate) {
                filteredList = filteredList.filter(t => t.date >= startDate);
            }
        }
        
        // S·∫Øp x·∫øp
        if (sortable) {
            filteredList.sort((a, b) => {
                let comparison = 0;
                const column = currentSort.column;

                if (column === 'date') {
                    comparison = new Date(a.date) - new Date(b.date);
                } else if (column === 'amount') {
                    comparison = a.amount - b.amount;
                }
                
                return currentSort.direction === 'asc' ? comparison : comparison * -1;
            });
        }
        
        const listElement = document.getElementById(displayElementId);
        listElement.innerHTML = ''; 

        if (filteredList.length === 0) {
            listElement.innerHTML = '<p style="text-align: center; padding: 20px; color: #6c757d;">Kh√¥ng t√¨m th·∫•y giao d·ªãch n√†o.</p>';
            if (displayElementId === 'search-results-items') {
                 document.getElementById('search-total-amount').textContent = formatMoney(0);
            }
            return;
        }
        
        let totalAmount = 0;

        filteredList.forEach(t => {
            totalAmount += t.amount;
            const item = document.createElement('div');
            item.className = 'transaction-item';
            item.innerHTML = `
                <span class="date">${formatDate(t.date)}</span>
                <span class="amount">${formatMoney(t.amount)}</span>
                <span class="category">${t.category}</span>
                <span class="note">${t.note}</span>
                <span class="actions-cell">
                    <button class="btn delete-btn btn-danger" data-id="${t.id}" title="X√≥a giao d·ªãch">X√≥a</button>
                    <button class="btn edit-btn" data-id="${t.id}" title="Ch·ªânh s·ª≠a giao d·ªãch">S·ª≠a</button>
                </span>
            `;
            listElement.appendChild(item);
        });
        
        if (displayElementId === 'search-results-items') {
            document.getElementById('search-total-amount').textContent = formatMoney(totalAmount);
        }

        // G√°n s·ª± ki·ªán cho n√∫t x√≥a
        listElement.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = Number(e.target.dataset.id);
                deleteExpense(id, displayElementId);
            });
        });
        
        // G√°n s·ª± ki·ªán cho n√∫t s·ª≠a
        listElement.querySelectorAll('.edit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = Number(e.target.dataset.id);
                openEditModal(id);
            });
        });

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i s·∫Øp x·∫øp
        document.querySelectorAll('.sort-header').forEach(header => {
            header.classList.remove('asc', 'desc');
            if (header.dataset.sortBy === currentSort.column) {
                header.classList.add(currentSort.direction);
            }
        });
    }

    // X√≥a giao d·ªãch
    function deleteExpense(id, listId = 'transaction-items') {
        if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a giao d·ªãch n√†y?")) {
            const initialLength = transactions.length;
            transactions = transactions.filter(t => t.id !== id);
            
            if (transactions.length < initialLength) {
                saveData();
                if (listId === 'transaction-items') {
                     updateTransactionList('all', 'transaction-items', true); 
                } else if (listId === 'search-results-items') {
                    performAdvancedSearch(true);
                }
                updateStats(currentPeriod); // C·∫≠p nh·∫≠t l·∫°i th·ªëng k√™
                updateLimitProgress();
                showNotification("üóëÔ∏è ƒê√£ x√≥a giao d·ªãch!");
            }
        }
    }
    
    // X√≥a to√†n b·ªô giao d·ªãch
	document.getElementById('delete-all-btn').addEventListener('click', function() {
		if (confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ giao d·ªãch kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!")) {
        	transactions = []; 
        	limits = {}; // X√≥a c·∫£ gi·ªõi h·∫°n
        	saveData();    
        	updateTransactionList('all', 'transaction-items', true); 
        	updateStats(currentPeriod);
       		updateLimitProgress();
        	showNotification("üóëÔ∏è ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu!");
    	}
	});

    // S·∫Øp x·∫øp danh s√°ch
    document.querySelectorAll('.sort-header').forEach(header => {
        header.addEventListener('click', (e) => {
            const column = e.currentTarget.dataset.sortBy;
            const parentList = e.currentTarget.closest('.transaction-list');
            const listId = parentList.querySelector('div:last-child').id;
            
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = column === 'date' ? 'desc' : 'asc';
            }
            
            if (listId === 'search-results-items') {
                performAdvancedSearch(true); 
            } else {
                // Ki·ªÉm tra xem c√≥ quick filter n√†o ƒëang √°p d·ª•ng kh√¥ng (Gi·∫£ s·ª≠ 'all' n·∫øu kh√¥ng c√≥ n√∫t n√†o ƒëang active)
                const activeFilterBtn = document.querySelector('.quick-filter-group .btn.active') || { onclick: 'updateTransactionList(\'all\')' };
                const filter = activeFilterBtn.onclick.match(/'(\w+)'/)[1];
                updateTransactionList(filter, listId, true);
            }
        });
    });

    // ==================== CH·ª®C NƒÇNG CH·ªàNH S·ª¨A ====================
    const editModal = document.getElementById('edit-modal');
    const closeBtn = editModal.querySelector('.close-btn');

    // M·ªü modal ch·ªânh s·ª≠a
    function openEditModal(id) {
        const transaction = transactions.find(t => t.id === id);
        if (!transaction) return;

        document.getElementById('edit-id').value = transaction.id;
        document.getElementById('edit-amount').value = transaction.amount;
        document.getElementById('edit-category').value = transaction.category;
        document.getElementById('edit-date').value = transaction.date;
        document.getElementById('edit-note').value = transaction.note;

        editModal.style.display = 'block';
    }

    // ƒê√≥ng modal
    closeBtn.onclick = function() {
        editModal.style.display = 'none';
    }

    window.onclick = function(event) {
        if (event.target == editModal) {
            editModal.style.display = 'none';
        }
    }

    // X·ª≠ l√Ω form ch·ªânh s·ª≠a
    document.getElementById('edit-transaction-form').addEventListener('submit', (e) => {
        e.preventDefault();

        const id = Number(document.getElementById('edit-id').value);
        const amount = Number(document.getElementById('edit-amount').value);
        const category = document.getElementById('edit-category').value;
        const date = document.getElementById('edit-date').value;
        const note = document.getElementById('edit-note').value.trim();

        const index = transactions.findIndex(t => t.id === id);

        if (index !== -1) {
            transactions[index] = { id, amount, category, date, note };
            saveData();
            
            // C·∫≠p nh·∫≠t l·∫°i danh s√°ch ƒëang hi·ªÉn th·ªã (·ªü tab Giao d·ªãch ho·∫∑c T√¨m ki·∫øm)
            const activeTab = document.querySelector('.tab-content.active').id;
            if (activeTab === 'tab-transaction') {
                updateTransactionList('all', 'transaction-items', true);
            } else if (activeTab === 'tab-search') {
                performAdvancedSearch(true);
            }
            
            updateStats(currentPeriod);
            updateLimitProgress();
            editModal.style.display = 'none';
            showNotification("üìù C·∫≠p nh·∫≠t giao d·ªãch th√†nh c√¥ng!");
        } else {
            showNotification("‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y giao d·ªãch!");
        }
    });


    // ==================== TAB T√åM KI·∫æM N√ÇNG CAO ====================
    document.getElementById('perform-search-btn').addEventListener('click', () => {
        performAdvancedSearch();
    });

    function performAdvancedSearch(isSort = false) {
        const fromDate = document.getElementById('search-from-date').value;
        const toDate = document.getElementById('search-to-date').value;
        const category = document.getElementById('search-category').value;
        const minAmount = Number(document.getElementById('search-min-amount').value);
        const note = document.getElementById('search-note').value.toLowerCase();

        let results = [...transactions];

        // L·ªçc theo ng√†y
        if (fromDate) {
            results = results.filter(t => t.date >= fromDate);
        }
        if (toDate) {
            results = results.filter(t => t.date <= toDate);
        }

        // L·ªçc theo danh m·ª•c
        if (category) {
            results = results.filter(t => t.category === category);
        }

        // L·ªçc theo s·ªë ti·ªÅn t·ªëi thi·ªÉu
        if (minAmount > 0) {
            results = results.filter(t => t.amount >= minAmount);
        }

        // L·ªçc theo ghi ch√∫
        if (note) {
            results = results.filter(t => t.note.toLowerCase().includes(note));
        }

        // T·∫°m th·ªùi s·ª≠ d·ª•ng m·∫£ng transactions ƒë·ªÉ h√†m updateTransactionList s·∫Øp x·∫øp v√† hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm
        const tempTransactionsForSearch = transactions; 
        transactions = results; 
        updateTransactionList('all', 'search-results-items', true);
        transactions = tempTransactionsForSearch; 
        
        if(!isSort) {
             showNotification(`üîç T√¨m th·∫•y ${results.length} giao d·ªãch.`);
        }
    }

    // ==================== TAB B√ÅO C√ÅO & TH·ªêNG K√ä ====================
    // H√†m t√≠nh to√°n th·ªëng k√™ (Gi·ªØ nguy√™n)
    function calculateStats(filteredList, periodName) {
        if (filteredList.length === 0) {
            return {
                total: 0,
                avgDaily: 0,
                max: 0,
                periodName: periodName
            };
        }

        const total = filteredList.reduce((sum, t) => sum + t.amount, 0);
        const max = filteredList.length > 0 ? Math.max(...filteredList.map(t => t.amount)) : 0;

        const uniqueDates = new Set(filteredList.map(t => t.date));
        const numDays = uniqueDates.size;
        const avgDaily = numDays > 0 ? total / numDays : 0;

        return { total, avgDaily, max, periodName };
    }

    // H√†m l·ªçc theo th·ªùi gian (Gi·ªØ nguy√™n)
    function filterTransactionsByPeriod(period) {
        const today = getTodayDateString(); 
        let startDate;

        if (period === 'month') {
            const now = new Date(today);
            startDate = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10);
        } else if (period === 'year') {
            const now = new Date(today);
            startDate = new Date(now.getFullYear(), 0, 1).toISOString().slice(0, 10);
        } else if (period === 'all') {
            return transactions;
        }

        return transactions.filter(t => t.date >= startDate);
    }
    
    // C·∫≠p nh·∫≠t th·ªëng k√™
    function updateStats(period) {
        currentPeriod = period;
        const periodName = period === 'month' ? 'Th√°ng N√†y' : (period === 'year' ? 'NƒÉm N√†y' : 'T·∫•t C·∫£');
        
        const filteredList = filterTransactionsByPeriod(period);
        const stats = calculateStats(filteredList, periodName);

        document.getElementById('stats-period-name').textContent = stats.periodName;
        document.getElementById('stats-total-expense').textContent = formatMoney(stats.total);
        document.getElementById('stats-avg-daily-expense').textContent = formatMoney(Math.round(stats.avgDaily));
        document.getElementById('stats-max-expense').textContent = formatMoney(stats.max);
        
        updateCharts();
    }


    // ==================== BI·ªÇU ƒê·ªí (CHART.JS) - T·ªêI ∆ØU ====================
    function getCategoryChartData(list) {
        const categoryData = {};
        const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6c757d', '#17a2b8', '#fd7e14'];
        let colorIndex = 0;

        list.forEach(t => {
            categoryData[t.category] = (categoryData[t.category] || 0) + t.amount;
        });

        const labels = Object.keys(categoryData);
        const data = labels.map(label => categoryData[label]);
        const backgroundColors = labels.map(() => colors[colorIndex++ % colors.length]);

        // T√≠nh t·ªïng ƒë·ªÉ t√≠nh ph·∫ßn trƒÉm
        const total = data.reduce((sum, amount) => sum + amount, 0);

        return { labels, data, backgroundColors, total };
    }

    function getMonthlyChartData(list) {
        // H√†m t√≠nh to√°n d·ªØ li·ªáu 12 th√°ng g·∫ßn nh·∫•t (Gi·ªØ nguy√™n)
        const monthlyData = {};
        const months = [];
        const today = new Date();
        
        for (let i = 11; i >= 0; i--) {
            const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            const monthLabel = `${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear().toString().slice(2)}`;
            months.push({ key: monthKey, label: monthLabel });
            monthlyData[monthKey] = 0;
        }

        list.forEach(t => {
            const monthKey = t.date.slice(0, 7); 
            if (monthlyData.hasOwnProperty(monthKey)) {
                monthlyData[monthKey] += t.amount;
            }
        });
        
        const data = months.map(m => monthlyData[m.key] || 0);
        const labels = months.map(m => m.label);

        return { labels, data };
    }

    function getDailyChartData(list) {
        // H√†m t√≠nh to√°n d·ªØ li·ªáu 30 ng√†y g·∫ßn nh·∫•t (Gi·ªØ nguy√™n)
        const dailyData = {};
        const days = [];
        const today = new Date(getTodayDateString());
        
        for (let i = 29; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(today.getDate() - i);
            const dayKey = date.toISOString().slice(0, 10);
            const dayLabel = `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
            days.push({ key: dayKey, label: dayLabel });
            dailyData[dayKey] = 0;
        }

        list.forEach(t => {
            if (dailyData.hasOwnProperty(t.date)) {
                dailyData[t.date] += t.amount;
            }
        });
        
        const data = days.map(d => dailyData[d.key] || 0);
        const labels = days.map(d => d.label);

        return { labels, data };
    }

    // C·∫≠p nh·∫≠t t·∫•t c·∫£ bi·ªÉu ƒë·ªì
    function updateCharts() {
        const list = transactions; 
        
        // 1. Bi·ªÉu ƒë·ªì Danh m·ª•c (T·ªëi ∆∞u DataLabels v√† Tooltip)
        const categoryData = getCategoryChartData(list);
        if (categoryChart) categoryChart.destroy();
        categoryChart = new Chart(document.getElementById('categoryChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: categoryData.labels,
                datasets: [{
                    data: categoryData.data,
                    backgroundColor: categoryData.backgroundColors,
                    hoverOffset: 10
                }]
            },
            plugins: [ChartDataLabels], // K√≠ch ho·∫°t plugin DataLabels
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'right' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed !== null) {
                                    const percentage = ((context.parsed / categoryData.total) * 100).toFixed(1);
                                    label += formatMoney(context.parsed) + ` (${percentage}%)`;
                                }
                                return label;
                            }
                        }
                    },
                    datalabels: { // C·∫•u h√¨nh DataLabels ƒë·ªÉ hi·ªÉn th·ªã % v√† s·ªë ti·ªÅn
                        formatter: (value, context) => {
                            const percentage = ((value / categoryData.total) * 100).toFixed(1);
                            return `${percentage}% \n ${formatMoney(value)}`;
                        },
                        color: '#fff',
                        font: {
                            weight: 'bold',
                            size: 12
                        },
                        textShadowBlur: 5,
                        textShadowColor: 'rgba(0,0,0,0.5)'
                    }
                }
            }
        });

        // 2. Bi·ªÉu ƒë·ªì Theo Th√°ng (T·ªëi ∆∞u Tooltip)
        const monthlyData = getMonthlyChartData(list);
        if (monthlyChart) monthlyChart.destroy();
        monthlyChart = new Chart(document.getElementById('monthlyChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: monthlyData.labels,
                datasets: [{
                    label: 'T·ªïng Chi Ti√™u',
                    data: monthlyData.data,
                    backgroundColor: '#007bff',
                    borderColor: '#007bff',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { 
                            callback: (value) => { 
                                if (value >= 1000000) return (value / 1000000).toFixed(1) + ' Tr';
                                return formatMoney(value);
                            } 
                        } 
                    }
                },
                plugins: {
                     tooltip: {
                        callbacks: {
                            label: (context) => `T·ªïng Chi Ti√™u: ${formatMoney(context.parsed.y)}`
                        }
                    }
                }
            }
        });
        
        // 3. Bi·ªÉu ƒë·ªì Theo Ng√†y (T·ªëi ∆∞u Tooltip)
        const dailyData = getDailyChartData(list);
        if (dailyChart) dailyChart.destroy();
        dailyChart = new Chart(document.getElementById('dailyChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: dailyData.labels,
                datasets: [{
                    label: 'Chi Ti√™u Ng√†y',
                    data: dailyData.data,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.2)',
                    fill: true,
                    tension: 0.2
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { 
                        beginAtZero: true, 
                        ticks: { 
                            callback: (value) => { 
                                if (value >= 1000000) return (value / 1000000).toFixed(1) + ' Tr';
                                return formatMoney(value);
                            } 
                        } 
                    }
                },
                plugins: {
                     tooltip: {
                        callbacks: {
                            label: (context) => `Chi Ti√™u: ${formatMoney(context.parsed.y)}`
                        }
                    }
                }
            }
        });
    }

    // ==================== TAB GI·ªöI H·∫†N CHI TI√äU ====================
    // Gi·ªØ nguy√™n logic Gi·ªõi H·∫°n Chi Ti√™u v√† C·∫≠p nh·∫≠t Ti·∫øn tr√¨nh
    document.getElementById('set-limit-btn').addEventListener('click', () => {
        const category = document.getElementById('limit-category').value;
        const amount = Number(document.getElementById('limit-amount').value);

        if (!category || amount <= 0) {
            showNotification("‚ùå Vui l√≤ng ch·ªçn danh m·ª•c v√† nh·∫≠p s·ªë ti·ªÅn gi·ªõi h·∫°n!");
            return;
        }

        limits[category] = amount;
        saveData();
        updateLimitProgress();
        showNotification(`üí∞ ƒê√£ thi·∫øt l·∫≠p gi·ªõi h·∫°n cho ${category} l√† ${formatMoney(amount)}!`);
    });

    function calculateCurrentExpense(key) {
        const today = getTodayDateString();
        const now = new Date();
        let totalExpense = 0;

        if (key === 'Daily') {
            totalExpense = transactions
                .filter(t => t.date === today)
                .reduce((sum, t) => sum + t.amount, 0);
        } else if (key === 'Monthly') {
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0, 10);
            totalExpense = transactions
                .filter(t => t.date >= startOfMonth)
                .reduce((sum, t) => sum + t.amount, 0);
        } else { 
            const currentMonthKey = now.toISOString().slice(0, 7); 
            totalExpense = transactions
                .filter(t => t.category === key && t.date.startsWith(currentMonthKey))
                .reduce((sum, t) => sum + t.amount, 0);
        }

        return totalExpense;
    }

    function updateLimitProgress() {
        const limitListElement = document.getElementById('limit-items');
        limitListElement.innerHTML = '';
        const limitKeys = Object.keys(limits);

        if (limitKeys.length === 0) {
            limitListElement.innerHTML = '<p style="text-align: center; padding: 20px; color: #6c757d;">Ch∆∞a c√≥ gi·ªõi h·∫°n n√†o ƒë∆∞·ª£c thi·∫øt l·∫≠p.</p>';
            return;
        }

        limitKeys.forEach(key => {
            const limitAmount = limits[key];
            const currentExpense = calculateCurrentExpense(key);
            const percentage = Math.min(100, (currentExpense / limitAmount) * 100);

            let progressBarClass = 'safe';
            if (percentage > 90) { // TƒÉng ng∆∞·ª°ng c·∫£nh b√°o l√™n 90%
                progressBarClass = 'danger';
            } else if (percentage > 60) {
                progressBarClass = 'warning';
            }

            const item = document.createElement('div');
            item.className = 'limit-item';
            
            let limitType = key;
            if (key === 'Daily') limitType = 'T·ªïng Chi Ti√™u H√†ng Ng√†y (H√¥m nay)';
            if (key === 'Monthly') limitType = 'T·ªïng Chi Ti√™u H√†ng Th√°ng (Th√°ng n√†y)';

            item.innerHTML = `
                <div class="limit-info">
                    <strong>${limitType}:</strong> ${formatMoney(currentExpense)} / ${formatMoney(limitAmount)}
                    <div class="progress-bar-container">
                        <div class="progress-bar ${progressBarClass}" style="width: ${Math.min(100, percentage).toFixed(1)}%;">
                            ${Math.min(100, percentage).toFixed(1)}%
                        </div>
                    </div>
                </div>
                <span class="limit-amount" style="color: ${currentExpense > limitAmount ? '#dc3545' : '#007bff'};">
                    ${currentExpense > limitAmount ? '‚õî V∆∞·ª£t Gi·ªõi H·∫°n' : '‚úÖ Trong Gi·ªõi H·∫°n'}
                </span>
                <button class="btn delete-limit-btn btn-danger" data-key="${key}" style="font-size: 14px;">X√≥a Gi·ªõi H·∫°n</button>
            `;
            limitListElement.appendChild(item);
        });

        // G√°n s·ª± ki·ªán x√≥a gi·ªõi h·∫°n
        limitListElement.querySelectorAll('.delete-limit-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const key = e.target.dataset.key;
                if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a gi·ªõi h·∫°n chi ti√™u cho "${key}" kh√¥ng?`)) {
                    delete limits[key];
                    saveData();
                    updateLimitProgress();
                    showNotification(`üóëÔ∏è ƒê√£ x√≥a gi·ªõi h·∫°n cho ${key}!`);
                }
            });
        });
    }


    // ==================== TAB C√îNG C·ª§ (IMPORT/EXPORT) ====================
    // Gi·ªØ nguy√™n logic Import/Export
    document.getElementById('export-csv-btn').addEventListener('click', () => {
        if (transactions.length === 0) {
            showNotification("‚ùå Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!");
            return;
        }
        
        const header = ["id", "date", "amount", "category", "note"];
        const rows = transactions.map(t => [
            t.id, 
            `"${t.date}"`, 
            t.amount, 
            `"${t.category}"`, 
            `"${t.note.replace(/"/g, '""')}"` 
        ].join(','));
        
        const csvContent = [header.join(','), ...rows].join('\n');
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', 'nhatkychitieu_export.csv');
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification("üì§ Xu·∫•t file CSV th√†nh c√¥ng!");
    });

    document.getElementById('import-csv-file').addEventListener('change', function() {
        document.getElementById('import-csv-btn').disabled = !this.files.length;
    });

    document.getElementById('import-csv-btn').addEventListener('click', () => {
        const fileInput = document.getElementById('import-csv-file');
        const file = fileInput.files[0];

        if (!file) {
            showNotification("‚ùå Vui l√≤ng ch·ªçn m·ªôt file CSV.");
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const csvText = event.target.result;
            try {
                const newTransactions = parseCSV(csvText);
                if (newTransactions.length === 0) {
                    showNotification("‚ùå File CSV tr·ªëng ho·∫∑c sai ƒë·ªãnh d·∫°ng.");
                    return;
                }
                
                const existingIds = new Set(transactions.map(t => t.id));
                newTransactions.forEach(t => {
                    while (existingIds.has(t.id)) {
                        t.id += 1; 
                    }
                    existingIds.add(t.id);
                    transactions.push(t);
                });
                
                saveData();
                updateTransactionList('all', 'transaction-items', true);
                updateLimitProgress();
                fileInput.value = ''; 
                document.getElementById('import-csv-btn').disabled = true;
                showNotification(`üì• ƒê√£ nh·∫≠p th√†nh c√¥ng ${newTransactions.length} giao d·ªãch!`);
            } catch (error) {
                console.error("L·ªói khi x·ª≠ l√Ω CSV:", error);
                showNotification("‚ùå L·ªói ƒë·ªãnh d·∫°ng file CSV. Vui l√≤ng ki·ªÉm tra l·∫°i.");
            }
        };
        reader.readAsText(file, 'UTF-8');
    });

    function parseCSV(text) {
        const lines = text.trim().split('\n');
        if (lines.length <= 1) return [];
        lines.shift(); 
        
        const newTransactions = [];

        for (const line of lines) {
            const values = parseCSVRow(line);
            
            if (values.length >= 5) {
                const [idStr, dateStr, amountStr, categoryStr, noteStr] = values;
                
                const id = Number(idStr);
                const amount = Number(amountStr);
                const date = dateStr.trim();
                const category = categoryStr.trim();
                const note = noteStr.trim();
                
                if (!isNaN(id) && amount > 0 && date && category) {
                    const finalId = isNaN(id) || id <= 0 ? Date.now() + Math.random() : id; 
                    newTransactions.push({
                        id: finalId,
                        date: date,
                        amount: amount,
                        category: category,
                        note: note
                    });
                }
            }
        }
        return newTransactions;
    }
    
    function parseCSVRow(text) {
        const result = [];
        let current = '';
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            if (char === '\"') {
                if (inQuotes && text[i + 1] === '\"') {
                    current += '\"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                result.push(current);
                current = '';
            } else if (char === '\r') {
                // B·ªè qua k√Ω t·ª± carriage return
            } else {
                current += char;
            }
        }
        result.push(current); 
        return result.map(s => s.trim().replace(/^\"|\"$/g, '')); 
    }
    
    // ==================== KH·ªûI CH·∫†Y ·ª®NG D·ª§NG ====================
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        updateTransactionList('all', 'transaction-items', true); 
        updateStats(currentPeriod); 
        updateLimitProgress();
    });
</script>

</body>
</html>
